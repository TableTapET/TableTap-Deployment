# Development

version: "3.8"

services:

  # Dev Nextjs frontend
  tabletap-web:
    container_name: Tabletap-frontend-dev
    build:
      context: ../TableTap-Frontend/
      dockerfile: ../TableTap-Frontend/Dockerfile
      target: dev
    init: true
    volumes:
      - type: bind
        source: ../TableTap-Frontend/
        target: /home/node/app/
      - type: volume
        target: /home/node/app/node_modules
    ports:
      - "${FRONTEND_HOST_PORT:-5002}:${FRONTEND_CONTAINER_PORT:-5002}"
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dev django backend
  tabletap-backend:
    container_name: TableTap-backend-dev
    build:
      context: ../TableTap-Backend/
      dockerfile: ../TableTap-Backend/Dockerfile
    ports:
      - 5001:5001
    entrypoint: ["/dev.entrypoint.sh"]
    volumes:
      - ../TableTap-Backend/:/TableTap-Backend
    environment:
      DEBUG: ${DEBUG}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      
      # Mail provider
      EMAIL_HOST: mailhog
      EMAIL_PORT: "1025"
      DJANGO_ENV: development

      # Databases
      MONGO_URI: mongodb://mongo:27018

      # PostgreSQL
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

      # S3 / MinIO envrionments
      AWS_S3_ENDPOINT_URL: http://minio:9000
      AWS_STORAGE_BUCKET_NAME: tabletap-media
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
    depends_on:
      tabletap-postgres:
        condition: service_healthy
      tabletap-mongo:
        condition: service_healthy
      tabletap-minio:
        condition: service_healthy

  # Dev Postgresql
  tabletap-postgres:
    image: postgres:17
    container_name: TableTap-postgres-dev
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d tabletap"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Dev mongodb
  tabletap-mongo:
    image: mongo:7
    container_name: TableTap-mongo-dev
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "27018:27018"
    command: ["mongod", "--auth", "--port", "27018"]
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: >
        mongosh --port 27018
        -u ${MONGO_INITDB_ROOT_USERNAME}
        -p ${MONGO_INITDB_ROOT_PASSWORD}
        --authenticationDatabase admin
        --eval "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
    
  # Dev mail server
  tabletap-mailhog:
    image: mailhog/mailhog
    container_name: TableTap-mailhog-dev
    ports: 
      - "1026:1026" # SMTP
      - "8026:8026" # Web UI
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dev minio/s3 bucket
  tabletap-minio:
    image: minio/minio
    container_name: TableTap-minio-dev
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # MinIO console
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 5

volumes:
  postgres_data:
  mongo_data:
  minio_data:
